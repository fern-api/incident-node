// This file was auto-generated by Fern from our API Definition.

import { IncidentIOClient } from "../../src/Client";
import { mockServerPool } from "../mock-server/MockServerPool";

describe("WorkflowsV2Client", () => {
    test("listworkflows", async () => {
        const server = mockServerPool.createServer();
        const client = new IncidentIOClient({ maxRetries: 0, environment: server.baseUrl });

        const rawResponseBody = {
            workflows: [
                {
                    condition_groups: [
                        {
                            conditions: [
                                {
                                    operation: { label: "Lawrence Jones", value: "01FCQSP07Z74QMMYPDDGQB9FTG" },
                                    param_bindings: [
                                        {
                                            array_value: [
                                                {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            ],
                                            value: {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        },
                                    ],
                                    subject: { label: "Incident Severity", reference: "incident.severity" },
                                },
                            ],
                        },
                    ],
                    continue_on_step_error: true,
                    delay: { conditions_apply_over_delay: false, for_seconds: 60 },
                    expressions: [
                        {
                            else_branch: {
                                result: {
                                    array_value: [
                                        { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                    ],
                                    value: {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                },
                            },
                            label: "Team Slack channel",
                            operations: [
                                {
                                    branches: {
                                        branches: [
                                            {
                                                condition_groups: [
                                                    {
                                                        conditions: [
                                                            {
                                                                operation: {
                                                                    label: "Lawrence Jones",
                                                                    value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                                },
                                                                param_bindings: [
                                                                    {
                                                                        array_value: [
                                                                            {
                                                                                label: "Lawrence Jones",
                                                                                literal: "SEV123",
                                                                                reference: "incident.severity",
                                                                            },
                                                                        ],
                                                                        value: {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    },
                                                                ],
                                                                subject: {
                                                                    label: "Incident Severity",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                    },
                                                ],
                                                result: {
                                                    array_value: [
                                                        {
                                                            label: "Lawrence Jones",
                                                            literal: "SEV123",
                                                            reference: "incident.severity",
                                                        },
                                                    ],
                                                    value: {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            },
                                        ],
                                        returns: { array: true, type: "IncidentStatus" },
                                    },
                                    filter: {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: {
                                                            label: "Lawrence Jones",
                                                            value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                        },
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: {
                                                            label: "Incident Severity",
                                                            reference: "incident.severity",
                                                        },
                                                    },
                                                ],
                                            },
                                        ],
                                    },
                                    navigate: { reference: "1235", reference_label: "Teams" },
                                    operation_type: "navigate",
                                    parse: {
                                        returns: { array: true, type: "IncidentStatus" },
                                        source: 'metadata.annotations["github.com/repo"]',
                                    },
                                    returns: { array: true, type: "IncidentStatus" },
                                },
                            ],
                            reference: "abc123",
                            returns: { array: true, type: "IncidentStatus" },
                            root_reference: "incident.status",
                        },
                    ],
                    folder: "My folder 01",
                    id: "01FCNDV6P870EA6S7TK1DSYDG0",
                    include_private_escalations: true,
                    include_private_incidents: true,
                    name: "My little workflow",
                    once_for: [
                        {
                            array: false,
                            key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                            label: "Incident -> Affected Team",
                            type: "IncidentSeverity",
                        },
                    ],
                    runs_from: "2021-08-17T13:28:57Z",
                    runs_on_incident_modes: ["standard", "test", "retrospective"],
                    runs_on_incidents: "newly_created",
                    shortform: "page-the-ceo",
                    state: "active",
                    steps: [{ label: "PagerDuty Escalate", name: "pagerduty.escalate" }],
                    trigger: { label: "Incident Updated", name: "incident.updated" },
                    version: 3,
                },
            ],
        };
        server.mockEndpoint().get("/v2/workflows").respondWith().statusCode(200).jsonBody(rawResponseBody).build();

        const response = await client.workflowsV2.listworkflows();
        expect(response).toEqual({
            workflows: [
                {
                    condition_groups: [
                        {
                            conditions: [
                                {
                                    operation: {
                                        label: "Lawrence Jones",
                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                    },
                                    param_bindings: [
                                        {
                                            array_value: [
                                                {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            ],
                                            value: {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        },
                                    ],
                                    subject: {
                                        label: "Incident Severity",
                                        reference: "incident.severity",
                                    },
                                },
                            ],
                        },
                    ],
                    continue_on_step_error: true,
                    delay: {
                        conditions_apply_over_delay: false,
                        for_seconds: 60,
                    },
                    expressions: [
                        {
                            else_branch: {
                                result: {
                                    array_value: [
                                        {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    ],
                                    value: {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                },
                            },
                            label: "Team Slack channel",
                            operations: [
                                {
                                    branches: {
                                        branches: [
                                            {
                                                condition_groups: [
                                                    {
                                                        conditions: [
                                                            {
                                                                operation: {
                                                                    label: "Lawrence Jones",
                                                                    value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                                },
                                                                param_bindings: [
                                                                    {
                                                                        array_value: [
                                                                            {
                                                                                label: "Lawrence Jones",
                                                                                literal: "SEV123",
                                                                                reference: "incident.severity",
                                                                            },
                                                                        ],
                                                                        value: {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    },
                                                                ],
                                                                subject: {
                                                                    label: "Incident Severity",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                    },
                                                ],
                                                result: {
                                                    array_value: [
                                                        {
                                                            label: "Lawrence Jones",
                                                            literal: "SEV123",
                                                            reference: "incident.severity",
                                                        },
                                                    ],
                                                    value: {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            },
                                        ],
                                        returns: {
                                            array: true,
                                            type: "IncidentStatus",
                                        },
                                    },
                                    filter: {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: {
                                                            label: "Lawrence Jones",
                                                            value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                        },
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: {
                                                            label: "Incident Severity",
                                                            reference: "incident.severity",
                                                        },
                                                    },
                                                ],
                                            },
                                        ],
                                    },
                                    navigate: {
                                        reference: "1235",
                                        reference_label: "Teams",
                                    },
                                    operation_type: "navigate",
                                    parse: {
                                        returns: {
                                            array: true,
                                            type: "IncidentStatus",
                                        },
                                        source: 'metadata.annotations["github.com/repo"]',
                                    },
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                },
                            ],
                            reference: "abc123",
                            returns: {
                                array: true,
                                type: "IncidentStatus",
                            },
                            root_reference: "incident.status",
                        },
                    ],
                    folder: "My folder 01",
                    id: "01FCNDV6P870EA6S7TK1DSYDG0",
                    include_private_escalations: true,
                    include_private_incidents: true,
                    name: "My little workflow",
                    once_for: [
                        {
                            array: false,
                            key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                            label: "Incident -> Affected Team",
                            type: "IncidentSeverity",
                        },
                    ],
                    runs_from: "2021-08-17T13:28:57Z",
                    runs_on_incident_modes: ["standard", "test", "retrospective"],
                    runs_on_incidents: "newly_created",
                    shortform: "page-the-ceo",
                    state: "active",
                    steps: [
                        {
                            label: "PagerDuty Escalate",
                            name: "pagerduty.escalate",
                        },
                    ],
                    trigger: {
                        label: "Incident Updated",
                        name: "incident.updated",
                    },
                    version: 3,
                },
            ],
        });
    });

    test("createworkflow", async () => {
        const server = mockServerPool.createServer();
        const client = new IncidentIOClient({ maxRetries: 0, environment: server.baseUrl });
        const rawRequestBody = {
            annotations: { "incident.io/terraform/version": "3.0.0" },
            condition_groups: [
                {
                    conditions: [
                        {
                            operation: "one_of",
                            param_bindings: [
                                {
                                    array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                                    value: { literal: "SEV123", reference: "incident.severity" },
                                },
                            ],
                            subject: "incident.severity",
                        },
                    ],
                },
            ],
            continue_on_step_error: true,
            delay: { conditions_apply_over_delay: false, for_seconds: 60 },
            expressions: [
                {
                    else_branch: {
                        result: {
                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                            value: { literal: "SEV123", reference: "incident.severity" },
                        },
                    },
                    label: "Team Slack channel",
                    operations: [
                        {
                            branches: {
                                branches: [
                                    {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: "one_of",
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: "incident.severity",
                                                    },
                                                ],
                                            },
                                        ],
                                        result: {
                                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                                            value: { literal: "SEV123", reference: "incident.severity" },
                                        },
                                    },
                                ],
                                returns: { array: true, type: "IncidentStatus" },
                            },
                            concatenate: { reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]' },
                            filter: {
                                condition_groups: [
                                    {
                                        conditions: [
                                            {
                                                operation: "one_of",
                                                param_bindings: [
                                                    {
                                                        array_value: [
                                                            { literal: "SEV123", reference: "incident.severity" },
                                                        ],
                                                        value: { literal: "SEV123", reference: "incident.severity" },
                                                    },
                                                ],
                                                subject: "incident.severity",
                                            },
                                        ],
                                    },
                                ],
                            },
                            navigate: { reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]' },
                            operation_type: "navigate",
                            parse: {
                                returns: { array: true, type: "IncidentStatus" },
                                source: 'metadata.annotations["github.com/repo"]',
                            },
                        },
                    ],
                    reference: "abc123",
                    root_reference: "incident.status",
                },
            ],
            folder: "My folder 01",
            include_private_escalations: true,
            include_private_incidents: true,
            name: "My little workflow",
            once_for: ["incident.url"],
            runs_on_incident_modes: ["standard", "test", "retrospective"],
            runs_on_incidents: "newly_created",
            shortform: "page-the-ceo",
            state: "active",
            steps: [
                {
                    for_each: "abc123",
                    id: "abc123",
                    name: "pagerduty.escalate",
                    param_bindings: [
                        {
                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                            value: { literal: "SEV123", reference: "incident.severity" },
                        },
                    ],
                },
            ],
            trigger: "incident.updated",
        };
        const rawResponseBody = {
            management_meta: {
                annotations: { "incident.io/terraform/version": "3.0.0" },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: { label: "Lawrence Jones", value: "01FCQSP07Z74QMMYPDDGQB9FTG" },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: { label: "Incident Severity", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: { conditions_apply_over_delay: false, for_seconds: 60 },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: { array: true, type: "IncidentStatus" },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: { reference: "1235", reference_label: "Teams" },
                                operation_type: "navigate",
                                parse: {
                                    returns: { array: true, type: "IncidentStatus" },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: { array: true, type: "IncidentStatus" },
                            },
                        ],
                        reference: "abc123",
                        returns: { array: true, type: "IncidentStatus" },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                trigger: { label: "Incident Updated", name: "incident.updated" },
                version: 3,
            },
        };
        server
            .mockEndpoint()
            .post("/v2/workflows")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.workflowsV2.createworkflow({
            annotations: {
                "incident.io/terraform/version": "3.0.0",
            },
            condition_groups: [
                {
                    conditions: [
                        {
                            operation: "one_of",
                            param_bindings: [
                                {
                                    array_value: [
                                        {
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    ],
                                    value: {
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                },
                            ],
                            subject: "incident.severity",
                        },
                    ],
                },
            ],
            continue_on_step_error: true,
            delay: {
                conditions_apply_over_delay: false,
                for_seconds: 60,
            },
            expressions: [
                {
                    else_branch: {
                        result: {
                            array_value: [
                                {
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            ],
                            value: {
                                literal: "SEV123",
                                reference: "incident.severity",
                            },
                        },
                    },
                    label: "Team Slack channel",
                    operations: [
                        {
                            branches: {
                                branches: [
                                    {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: "one_of",
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: "incident.severity",
                                                    },
                                                ],
                                            },
                                        ],
                                        result: {
                                            array_value: [
                                                {
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            ],
                                            value: {
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        },
                                    },
                                ],
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                            },
                            concatenate: {
                                reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]',
                            },
                            filter: {
                                condition_groups: [
                                    {
                                        conditions: [
                                            {
                                                operation: "one_of",
                                                param_bindings: [
                                                    {
                                                        array_value: [
                                                            {
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        ],
                                                        value: {
                                                            literal: "SEV123",
                                                            reference: "incident.severity",
                                                        },
                                                    },
                                                ],
                                                subject: "incident.severity",
                                            },
                                        ],
                                    },
                                ],
                            },
                            navigate: {
                                reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]',
                            },
                            operation_type: "navigate",
                            parse: {
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                                source: 'metadata.annotations["github.com/repo"]',
                            },
                        },
                    ],
                    reference: "abc123",
                    root_reference: "incident.status",
                },
            ],
            folder: "My folder 01",
            include_private_escalations: true,
            include_private_incidents: true,
            name: "My little workflow",
            once_for: ["incident.url"],
            runs_on_incident_modes: ["standard", "test", "retrospective"],
            runs_on_incidents: "newly_created",
            shortform: "page-the-ceo",
            state: "active",
            steps: [
                {
                    for_each: "abc123",
                    id: "abc123",
                    name: "pagerduty.escalate",
                    param_bindings: [
                        {
                            array_value: [
                                {
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            ],
                            value: {
                                literal: "SEV123",
                                reference: "incident.severity",
                            },
                        },
                    ],
                },
            ],
            trigger: "incident.updated",
        });
        expect(response).toEqual({
            management_meta: {
                annotations: {
                    "incident.io/terraform/version": "3.0.0",
                },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: {
                                    label: "Lawrence Jones",
                                    value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: {
                                    label: "Incident Severity",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: {
                    conditions_apply_over_delay: false,
                    for_seconds: 60,
                },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: {
                                    reference: "1235",
                                    reference_label: "Teams",
                                },
                                operation_type: "navigate",
                                parse: {
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                            },
                        ],
                        reference: "abc123",
                        returns: {
                            array: true,
                            type: "IncidentStatus",
                        },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                trigger: {
                    label: "Incident Updated",
                    name: "incident.updated",
                },
                version: 3,
            },
        });
    });

    test("showworkflow", async () => {
        const server = mockServerPool.createServer();
        const client = new IncidentIOClient({ maxRetries: 0, environment: server.baseUrl });

        const rawResponseBody = {
            management_meta: {
                annotations: { "incident.io/terraform/version": "3.0.0" },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: { label: "Lawrence Jones", value: "01FCQSP07Z74QMMYPDDGQB9FTG" },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: { label: "Incident Severity", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: { conditions_apply_over_delay: false, for_seconds: 60 },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: { array: true, type: "IncidentStatus" },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: { reference: "1235", reference_label: "Teams" },
                                operation_type: "navigate",
                                parse: {
                                    returns: { array: true, type: "IncidentStatus" },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: { array: true, type: "IncidentStatus" },
                            },
                        ],
                        reference: "abc123",
                        returns: { array: true, type: "IncidentStatus" },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                trigger: { label: "Incident Updated", name: "incident.updated" },
                version: 3,
            },
        };
        server
            .mockEndpoint()
            .get("/v2/workflows/01FCNDV6P870EA6S7TK1DSYDG0")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.workflowsV2.showworkflow({
            id: "01FCNDV6P870EA6S7TK1DSYDG0",
            skip_step_upgrades: false,
        });
        expect(response).toEqual({
            management_meta: {
                annotations: {
                    "incident.io/terraform/version": "3.0.0",
                },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: {
                                    label: "Lawrence Jones",
                                    value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: {
                                    label: "Incident Severity",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: {
                    conditions_apply_over_delay: false,
                    for_seconds: 60,
                },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: {
                                    reference: "1235",
                                    reference_label: "Teams",
                                },
                                operation_type: "navigate",
                                parse: {
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                            },
                        ],
                        reference: "abc123",
                        returns: {
                            array: true,
                            type: "IncidentStatus",
                        },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                trigger: {
                    label: "Incident Updated",
                    name: "incident.updated",
                },
                version: 3,
            },
        });
    });

    test("updateworkflow", async () => {
        const server = mockServerPool.createServer();
        const client = new IncidentIOClient({ maxRetries: 0, environment: server.baseUrl });
        const rawRequestBody = {
            annotations: { "incident.io/terraform/version": "3.0.0" },
            condition_groups: [
                {
                    conditions: [
                        {
                            operation: "one_of",
                            param_bindings: [
                                {
                                    array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                                    value: { literal: "SEV123", reference: "incident.severity" },
                                },
                            ],
                            subject: "incident.severity",
                        },
                    ],
                },
            ],
            continue_on_step_error: true,
            delay: { conditions_apply_over_delay: false, for_seconds: 60 },
            expressions: [
                {
                    else_branch: {
                        result: {
                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                            value: { literal: "SEV123", reference: "incident.severity" },
                        },
                    },
                    label: "Team Slack channel",
                    operations: [
                        {
                            branches: {
                                branches: [
                                    {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: "one_of",
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: "incident.severity",
                                                    },
                                                ],
                                            },
                                        ],
                                        result: {
                                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                                            value: { literal: "SEV123", reference: "incident.severity" },
                                        },
                                    },
                                ],
                                returns: { array: true, type: "IncidentStatus" },
                            },
                            concatenate: { reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]' },
                            filter: {
                                condition_groups: [
                                    {
                                        conditions: [
                                            {
                                                operation: "one_of",
                                                param_bindings: [
                                                    {
                                                        array_value: [
                                                            { literal: "SEV123", reference: "incident.severity" },
                                                        ],
                                                        value: { literal: "SEV123", reference: "incident.severity" },
                                                    },
                                                ],
                                                subject: "incident.severity",
                                            },
                                        ],
                                    },
                                ],
                            },
                            navigate: { reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]' },
                            operation_type: "navigate",
                            parse: {
                                returns: { array: true, type: "IncidentStatus" },
                                source: 'metadata.annotations["github.com/repo"]',
                            },
                        },
                    ],
                    reference: "abc123",
                    root_reference: "incident.status",
                },
            ],
            folder: "My folder 01",
            include_private_escalations: true,
            include_private_incidents: true,
            name: "My little workflow",
            once_for: ["incident.url"],
            runs_on_incident_modes: ["standard", "test", "retrospective"],
            runs_on_incidents: "newly_created",
            shortform: "page-the-ceo",
            state: "active",
            steps: [
                {
                    for_each: "abc123",
                    id: "abc123",
                    name: "pagerduty.escalate",
                    param_bindings: [
                        {
                            array_value: [{ literal: "SEV123", reference: "incident.severity" }],
                            value: { literal: "SEV123", reference: "incident.severity" },
                        },
                    ],
                },
            ],
        };
        const rawResponseBody = {
            management_meta: {
                annotations: { "incident.io/terraform/version": "3.0.0" },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: { label: "Lawrence Jones", value: "01FCQSP07Z74QMMYPDDGQB9FTG" },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: { label: "Incident Severity", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: { conditions_apply_over_delay: false, for_seconds: 60 },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: { array: true, type: "IncidentStatus" },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: { reference: "1235", reference_label: "Teams" },
                                operation_type: "navigate",
                                parse: {
                                    returns: { array: true, type: "IncidentStatus" },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: { array: true, type: "IncidentStatus" },
                            },
                        ],
                        reference: "abc123",
                        returns: { array: true, type: "IncidentStatus" },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                                ],
                                value: { label: "Lawrence Jones", literal: "SEV123", reference: "incident.severity" },
                            },
                        ],
                    },
                ],
                trigger: { label: "Incident Updated", name: "incident.updated" },
                version: 3,
            },
        };
        server
            .mockEndpoint()
            .put("/v2/workflows/01FCNDV6P870EA6S7TK1DSYDG0")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.workflowsV2.updateworkflow({
            id: "01FCNDV6P870EA6S7TK1DSYDG0",
            annotations: {
                "incident.io/terraform/version": "3.0.0",
            },
            condition_groups: [
                {
                    conditions: [
                        {
                            operation: "one_of",
                            param_bindings: [
                                {
                                    array_value: [
                                        {
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    ],
                                    value: {
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                },
                            ],
                            subject: "incident.severity",
                        },
                    ],
                },
            ],
            continue_on_step_error: true,
            delay: {
                conditions_apply_over_delay: false,
                for_seconds: 60,
            },
            expressions: [
                {
                    else_branch: {
                        result: {
                            array_value: [
                                {
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            ],
                            value: {
                                literal: "SEV123",
                                reference: "incident.severity",
                            },
                        },
                    },
                    label: "Team Slack channel",
                    operations: [
                        {
                            branches: {
                                branches: [
                                    {
                                        condition_groups: [
                                            {
                                                conditions: [
                                                    {
                                                        operation: "one_of",
                                                        param_bindings: [
                                                            {
                                                                array_value: [
                                                                    {
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                ],
                                                                value: {
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            },
                                                        ],
                                                        subject: "incident.severity",
                                                    },
                                                ],
                                            },
                                        ],
                                        result: {
                                            array_value: [
                                                {
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            ],
                                            value: {
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        },
                                    },
                                ],
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                            },
                            concatenate: {
                                reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]',
                            },
                            filter: {
                                condition_groups: [
                                    {
                                        conditions: [
                                            {
                                                operation: "one_of",
                                                param_bindings: [
                                                    {
                                                        array_value: [
                                                            {
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        ],
                                                        value: {
                                                            literal: "SEV123",
                                                            reference: "incident.severity",
                                                        },
                                                    },
                                                ],
                                                subject: "incident.severity",
                                            },
                                        ],
                                    },
                                ],
                            },
                            navigate: {
                                reference: 'catalog_attribute["01FCNDV6P870EA6S7TK1DSYD5H"]',
                            },
                            operation_type: "navigate",
                            parse: {
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                                source: 'metadata.annotations["github.com/repo"]',
                            },
                        },
                    ],
                    reference: "abc123",
                    root_reference: "incident.status",
                },
            ],
            folder: "My folder 01",
            include_private_escalations: true,
            include_private_incidents: true,
            name: "My little workflow",
            once_for: ["incident.url"],
            runs_on_incident_modes: ["standard", "test", "retrospective"],
            runs_on_incidents: "newly_created",
            shortform: "page-the-ceo",
            state: "active",
            steps: [
                {
                    for_each: "abc123",
                    id: "abc123",
                    name: "pagerduty.escalate",
                    param_bindings: [
                        {
                            array_value: [
                                {
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            ],
                            value: {
                                literal: "SEV123",
                                reference: "incident.severity",
                            },
                        },
                    ],
                },
            ],
        });
        expect(response).toEqual({
            management_meta: {
                annotations: {
                    "incident.io/terraform/version": "3.0.0",
                },
                managed_by: "dashboard",
                source_url: "https://github.com/my-company/infrastructure",
            },
            workflow: {
                condition_groups: [
                    {
                        conditions: [
                            {
                                operation: {
                                    label: "Lawrence Jones",
                                    value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                },
                                param_bindings: [
                                    {
                                        array_value: [
                                            {
                                                label: "Lawrence Jones",
                                                literal: "SEV123",
                                                reference: "incident.severity",
                                            },
                                        ],
                                        value: {
                                            label: "Lawrence Jones",
                                            literal: "SEV123",
                                            reference: "incident.severity",
                                        },
                                    },
                                ],
                                subject: {
                                    label: "Incident Severity",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                continue_on_step_error: true,
                delay: {
                    conditions_apply_over_delay: false,
                    for_seconds: 60,
                },
                expressions: [
                    {
                        else_branch: {
                            result: {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        },
                        label: "Team Slack channel",
                        operations: [
                            {
                                branches: {
                                    branches: [
                                        {
                                            condition_groups: [
                                                {
                                                    conditions: [
                                                        {
                                                            operation: {
                                                                label: "Lawrence Jones",
                                                                value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                            },
                                                            param_bindings: [
                                                                {
                                                                    array_value: [
                                                                        {
                                                                            label: "Lawrence Jones",
                                                                            literal: "SEV123",
                                                                            reference: "incident.severity",
                                                                        },
                                                                    ],
                                                                    value: {
                                                                        label: "Lawrence Jones",
                                                                        literal: "SEV123",
                                                                        reference: "incident.severity",
                                                                    },
                                                                },
                                                            ],
                                                            subject: {
                                                                label: "Incident Severity",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                },
                                            ],
                                            result: {
                                                array_value: [
                                                    {
                                                        label: "Lawrence Jones",
                                                        literal: "SEV123",
                                                        reference: "incident.severity",
                                                    },
                                                ],
                                                value: {
                                                    label: "Lawrence Jones",
                                                    literal: "SEV123",
                                                    reference: "incident.severity",
                                                },
                                            },
                                        },
                                    ],
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                },
                                filter: {
                                    condition_groups: [
                                        {
                                            conditions: [
                                                {
                                                    operation: {
                                                        label: "Lawrence Jones",
                                                        value: "01FCQSP07Z74QMMYPDDGQB9FTG",
                                                    },
                                                    param_bindings: [
                                                        {
                                                            array_value: [
                                                                {
                                                                    label: "Lawrence Jones",
                                                                    literal: "SEV123",
                                                                    reference: "incident.severity",
                                                                },
                                                            ],
                                                            value: {
                                                                label: "Lawrence Jones",
                                                                literal: "SEV123",
                                                                reference: "incident.severity",
                                                            },
                                                        },
                                                    ],
                                                    subject: {
                                                        label: "Incident Severity",
                                                        reference: "incident.severity",
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                navigate: {
                                    reference: "1235",
                                    reference_label: "Teams",
                                },
                                operation_type: "navigate",
                                parse: {
                                    returns: {
                                        array: true,
                                        type: "IncidentStatus",
                                    },
                                    source: 'metadata.annotations["github.com/repo"]',
                                },
                                returns: {
                                    array: true,
                                    type: "IncidentStatus",
                                },
                            },
                        ],
                        reference: "abc123",
                        returns: {
                            array: true,
                            type: "IncidentStatus",
                        },
                        root_reference: "incident.status",
                    },
                ],
                folder: "My folder 01",
                id: "01FCNDV6P870EA6S7TK1DSYDG0",
                include_private_escalations: true,
                include_private_incidents: true,
                name: "My little workflow",
                once_for: [
                    {
                        array: false,
                        key: 'incident.custom_field["01FCNDV6P870EA6S7TK1DSYDG0"]',
                        label: "Incident -> Affected Team",
                        type: "IncidentSeverity",
                    },
                ],
                runs_from: "2021-08-17T13:28:57Z",
                runs_on_incident_modes: ["standard", "test", "retrospective"],
                runs_on_incidents: "newly_created",
                shortform: "page-the-ceo",
                state: "active",
                steps: [
                    {
                        for_each: "abc123",
                        id: "abc123",
                        label: "PagerDuty Escalate",
                        name: "pagerduty.escalate",
                        param_bindings: [
                            {
                                array_value: [
                                    {
                                        label: "Lawrence Jones",
                                        literal: "SEV123",
                                        reference: "incident.severity",
                                    },
                                ],
                                value: {
                                    label: "Lawrence Jones",
                                    literal: "SEV123",
                                    reference: "incident.severity",
                                },
                            },
                        ],
                    },
                ],
                trigger: {
                    label: "Incident Updated",
                    name: "incident.updated",
                },
                version: 3,
            },
        });
    });

    test("destroyworkflow", async () => {
        const server = mockServerPool.createServer();
        const client = new IncidentIOClient({ maxRetries: 0, environment: server.baseUrl });

        server.mockEndpoint().delete("/v2/workflows/01FCNDV6P870EA6S7TK1DSYDG0").respondWith().statusCode(200).build();

        const response = await client.workflowsV2.destroyworkflow({
            id: "01FCNDV6P870EA6S7TK1DSYDG0",
        });
        expect(response).toEqual(undefined);
    });
});
